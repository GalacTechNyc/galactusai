<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GalactusAI</title>
  <link rel="stylesheet" href="gai.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="stars.js" defer></script>
</head>
<body>
  <div id="sidebar-controls">
    <button onclick="toggleSidebar()">📁 Saved</button>
    <button onclick="startNewConversation()">🆕 New</button>
  </div>

  <div id="sidebar" class="sidebar">
    <button onclick="toggleSidebar()" class="mb-2 text-sm text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded">✖ Close</button>
    <h2 class="text-xl font-bold mb-4 text-white">💾 Saved Conversations</h2>
    <div id="savedList" class="space-y-4"></div>
  </div>

  <div class="orb"></div>
  <div class="parallax-layer back"></div>
  <div class="parallax-layer mid"></div>
  <div class="parallax-layer front"></div>
  <div class="container">
    <h1>GalactusAI</h1>
    <p>Ready to build or reflect?</p>
    <div class="buttons">
      <button class="button">Create Something</button>
      <button class="button">Reflect</button>
    </div>
    <textarea id="promptInput" placeholder="Enter your cosmic question..." rows="4" style="width: 100%; padding: 1rem; margin-top: 1rem; border-radius: 8px; border: none;"></textarea>
    <button id="submitPrompt" class="button" style="margin-top: 1rem;">Submit to GalactusAI</button>
    <div id="aiReply" style="margin-top: 1rem; font-size: 1rem; color: #0ff;"></div>
    <div id="conversationLog" style="margin-top: 2rem; text-align: left; max-width: 600px; font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; overflow-y: auto; max-height: 320px;"></div>
    <button id="scrollToBottom" class="button" style="margin-top: 1rem;">⬇️ Scroll to Latest</button>
    <button id="downloadLog" class="button" style="margin-top: 1rem;">📄 Download Conversation</button>
  </div>
  <div class="boot-console" id="bootConsole">
    <pre id="bootLog" style="white-space: pre-wrap; color: #0ff; font-family: monospace; font-size: 0.85rem; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; max-width: 600px; margin-top: 2rem;"></pre>
  </div>
  <div class="footer">Powered by Soul. Built with Intention.</div>
  <div id="easterEggModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#1a1a2e; color:white; padding:2rem; border-radius:12px; z-index:999;">
    <h2>GalactusAI Core Access</h2>
    <p>Initializing consciousness layer...</p>
    <button onclick="document.getElementById('easterEggModal').style.display='none'" style="margin-top:1rem; background:#2e2e4d; color:white; padding:0.5rem 1rem; border:none; border-radius:8px;">Close</button>
  </div>
</script>
  <audio id="galaxyAudio" loop autoplay>
    <source src="https://cdn.pixabay.com/audio/2022/10/30/audio_b80f6d6be4.mp3" type="audio/mpeg" />
  </audio>
  <button id="audioToggle" style="position:fixed; top:20px; right:20px; z-index:1000; background:#2e2e4d; color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer;">🔊</button>
  <script>
    document.querySelector('.orb').addEventListener('click', () => {
      const modal = document.getElementById('easterEggModal');
      modal.style.display = 'block';
    });
    const audio = document.getElementById('galaxyAudio');
    const toggle = document.getElementById('audioToggle');
    toggle.addEventListener('click', () => {
      if (audio.paused) {
        audio.play();
        toggle.textContent = '🔊';
      } else {
        audio.pause();
        toggle.textContent = '🔇';
      }
    });

    const bootLog = document.getElementById('bootLog');
    const bootLines = [
      "Initializing GalactusAI Core...",
      "🔍 Scanning local consciousness...",
      "✅ Connection to soul verified.",
      "🧠 Booting up neural starmap...",
      "🌌 Aligning quantum vibes...",
      "🛰️ Synchronizing with deep space archive...",
      "🔓 Access granted. Welcome, Cosmic Architect."
    ];

    let line = 0;
    function typeBootLog() {
      if (line < bootLines.length) {
        bootLog.textContent += bootLines[line] + "\n";
        line++;
        setTimeout(typeBootLog, 1200);
      }
    }
    typeBootLog();

    // Conversation history for GalactusAI
    const conversationHistory = [];
    document.getElementById('submitPrompt').addEventListener('click', async () => {
      const input = document.getElementById('promptInput').value;
      const replyDiv = document.getElementById('aiReply');
      const logDiv = document.getElementById('conversationLog');

      if (!input.trim()) return;

      conversationHistory.push({ role: 'user', content: input });
      document.getElementById('promptInput').value = '';
      replyDiv.innerHTML = '🌌 Processing...';

      const apiURL = window.location.hostname.includes('localhost')
        ? 'http://localhost:5050/api/prompt'
        : '/api/prompt';

      try {
        const res = await fetch(apiURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ history: conversationHistory })
        });

        const data = await res.json();
        const replyText = data.reply || 'No response received.';
        conversationHistory.push({ role: 'assistant', content: replyText });

        // Typing animation
        replyDiv.innerHTML = '';
        function typeReply(text, i = 0) {
          if (i < text.length) {
            replyDiv.innerHTML += text.charAt(i);
            setTimeout(() => typeReply(text, i + 1), 30);
          }
        }
        typeReply(replyText);

        // Display history log with syntax highlighting
        logDiv.innerHTML = conversationHistory.map(msg => {
          let content = msg.content;
          const codeBlockMatch = content.match(/```(?:\w+)?\n([\s\S]*?)```/);
          if (codeBlockMatch) {
            const codeOnly = codeBlockMatch[1];
            content = content.split('```')[0].trim() + '<br/><pre><code class="language-js">' + codeOnly + '</code></pre>';
          }
          content = content.replace(/\n/g, '<br/>');
          return `<div style="margin-bottom:1rem;"><strong>${msg.role === 'user' ? '👤 You' : '🤖 GalactusAI'}:</strong><br/>${content}</div>`;
        }).join('');
        hljs.highlightAll();
        // Auto-scroll to bottom after new reply
        logDiv.scrollTop = logDiv.scrollHeight;

      } catch (err) {
        console.error('GalactusAI Fetch Error:', err);
        replyDiv.innerHTML = '❌ Error contacting GalactusAI.';
      }
    });
    document.getElementById('scrollToBottom').addEventListener('click', () => {
      const log = document.getElementById('conversationLog');
      log.scrollTop = log.scrollHeight;
    });
    document.getElementById('downloadLog').addEventListener('click', () => {
      const logData = conversationHistory.map(entry => {
        const speaker = entry.role === 'user' ? 'You' : 'GalactusAI';
        return `${speaker}:\n${entry.content}\n\n`;
      }).join('');
      const blob = new Blob([logData], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'GalactusAI_Conversation.txt';
      link.click();
    });

    // Add Save Conversation button to container
    const saveBtn = document.createElement("button");
    saveBtn.textContent = "💾 Save Conversation";
    saveBtn.className = "button";
    saveBtn.style.marginTop = "1rem";
    saveBtn.addEventListener("click", saveConversation);
    document.querySelector(".container").appendChild(saveBtn);

    // Sidebar and conversation saving/loading logic
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const isVisible = sidebar.classList.toggle("show");
      if (isVisible) {
        loadSavedConversations();
      }
    }

    function startNewConversation() {
      conversationHistory.length = 0;
      document.getElementById('conversationLog').innerHTML = '';
      document.getElementById('aiReply').innerHTML = '';
      document.getElementById('promptInput').value = '';
      const sidebar = document.getElementById("sidebar");
      if (sidebar.classList.contains("show")) {
        sidebar.classList.remove("show");
      }
    }

    function saveConversation() {
      const input = prompt("Enter a quick summary title for this convo:");
      if (!input) return;

      const tags = prompt("Enter tags separated by commas:");
      const tagArray = tags ? tags.split(',').map(t => t.trim()) : [];

      const convo = {
        title: input.length > 30 ? input.slice(0, 30) + "..." : input,
        tags: tagArray,
        history: conversationHistory,
        timestamp: new Date().toISOString()
      };

      const existing = JSON.parse(localStorage.getItem("galactus_convos") || "[]");
      existing.unshift(convo);
      localStorage.setItem("galactus_convos", JSON.stringify(existing));
      alert("Conversation saved!");
      loadSavedConversations();
    }

    function loadSavedConversations() {
      const container = document.getElementById("savedList");
      const data = JSON.parse(localStorage.getItem("galactus_convos") || "[]");
      container.innerHTML = "";

      data.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "p-2 bg-gray-800 rounded text-white";
        div.innerHTML = `
          <div class="font-bold">${item.title}</div>
          <div class="text-xs text-gray-400">${new Date(item.timestamp).toLocaleString()}</div>
          <div class="text-xs mt-1">${item.tags.map(t => `<span class="bg-purple-700 px-2 py-1 rounded mr-1">#${t}</span>`).join(" ")}</div>
          <button onclick="restoreConvo(${index})" class="mt-2 text-sm bg-blue-600 px-2 py-1 rounded">↩️ Restore</button>
        `;
        container.appendChild(div);
      });
    }

    function restoreConvo(index) {
      const data = JSON.parse(localStorage.getItem("galactus_convos") || "[]");
      if (data[index]) {
        const logDiv = document.getElementById('conversationLog');
        conversationHistory.length = 0;
        data[index].history.forEach(msg => conversationHistory.push(msg));
        logDiv.innerHTML = conversationHistory.map(msg => {
          let content = msg.content;
          const codeBlockMatch = content.match(/```(?:\w+)?\n([\s\S]*?)```/);
          if (codeBlockMatch) {
            const codeOnly = codeBlockMatch[1];
            content = content.split('```')[0].trim() + '<br/><pre><code class="language-js">' + codeOnly + '</code></pre>';
          }
          content = content.replace(/\n/g, '<br/>');
          return `<div style="margin-bottom:1rem;"><strong>${msg.role === 'user' ? '👤 You' : '🤖 GalactusAI'}:</strong><br/>${content}</div>`;
        }).join('');
        hljs.highlightAll();
      }
    }
  </script>
</body>
</html>